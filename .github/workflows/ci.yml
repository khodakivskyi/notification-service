name: CI

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Docker image
      run: docker build -t notification-service:test .

    - name: Test Docker container
      run: |
        docker run -d --name test \
          -e NODE_ENV=test \
          -e PORT=3001 \
          -e DATABASE_URL=postgresql://test:test@localhost:5432/test \
          -e SMTP_HOST=smtp.example.com \
          -e SMTP_PORT=587 \
          -e SMTP_USER=test@example.com \
          -e SMTP_PASS=testpass \
          notification-service:test
        
        sleep 8
        docker exec test curl -f http://localhost:3001/health || exit 1
        docker stop test
        echo "âœ… Health check passed!"
