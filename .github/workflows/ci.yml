name: CI

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Docker image
      run: docker build -t notification-service:test .

    - name: Test Docker container
      run: |
        docker run -d --name test \
          -e NODE_ENV=test \
          -e PORT=3001 \
          -e LOG_LEVEL=info \
          -e DATABASE_URL=postgresql://test:test@localhost:5432/test \
          -e SMTP_HOST=smtp.example.com \
          -e SMTP_PORT=587 \
          -e SMTP_USER=test@example.com \
          -e SMTP_PASS=testpass \
          -p 3001:3001 \
          notification-service:test

        # Wait for container to start
        sleep 10
        
        # Check container logs for debugging
        echo "Container logs:"
        docker logs test || true
        
        # Test health endpoint
        curl -f http://localhost:3001/api/health || (docker logs test && exit 1)
        
        # Cleanup
        docker stop test
        docker rm test || true
        echo "âœ… Health check passed!"
